<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Desktop White</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Helvetica, Arial, sans-serif;
            background: #FFFAEC;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        .container {
            width: 2060px;
            height: 1440px;
            background: #FFFAEC;
            position: relative;
            transform-origin: 0 0;
            transform: scale(0.5);
        }

        .album-cover {
            position: absolute;
            left: 63px;
            top: 57px;
            width: 680px;
            height: 680px;
            background-image: url({{cover_image}});
            background-color: grey;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        .artist-name {
            position: absolute;
            left: 61px;
            top: 767px;
            font-family: Helvetica, sans-serif;
            font-size: 30px;
            font-weight: normal;
            color: black;
        }

        .album-title {
            position: absolute;
            left: 56px;
            top: 811px;
            font-family: Helvetica, sans-serif;
            font-size: 96px;
            font-weight: bold;
            color: black;
            width: 680px;
            overflow: hidden;
        }

        .color-1 {
            left: 472px;
            width: 39px;
            height: 39px;
            background-color: {{ colours[0] }};
            position: absolute;
            top: 762px;
        }

        .color-2 {
            left: 530px;
            width: 39px;
            height: 39px;
            background-color: {{ colours[1] }};
            position: absolute;
            top: 762px;
        }

        .color-3 {
            left: 588px;
            width: 39px;
            height: 39px;
            background-color: {{ colours[2] }};
            position: absolute;
            top: 762px;
        }

        .color-4 {
            left: 646px;
            width: 39px;
            height: 39px;
            background-color: {{ colours[3] }};
            position: absolute;
            top: 762px;
        }

        .color-5 {
            left: 704px;
            width: 39px;
            height: 39px;
            background-color: {{ colours[4] }};
            position: absolute;
            top: 762px;
        }

        .separator-line {
            position: absolute;
            left: 63px;
            top: 941px;
            width: 94%;
            height: 5px;
            background-color: #000000;
        }

        .track-list {
            position: absolute;
            left: 858px;
            top: 57px;
            width: 508px;
        }

        .track-item {
            position: relative;
            height: 117px;
            margin-bottom: 29px;
            overflow: hidden;
        }

        .track-number {
            position: absolute;
            left: 0;
            top: 37px;
            transform: translateY(-50%);
            font-family: Helvetica, sans-serif;
            font-size: 35px;
            font-weight: bold;
            color: black;
            text-align: center;
            width: 48px;
        }

        .track-title {
            position: absolute;
            left: 60px;
            top: 15px;
            font-family: Helvetica, sans-serif;
            font-weight: bold;
            color: black;
            width: 440px;
            line-height: 1.1;
            height: 45px;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .track-duration {
            position: absolute;
            left: 63px;
            top: 74px;
            font-family: Helvetica, sans-serif;
            font-size: 24px;
            font-weight: normal;
            color: #3c3c3c;
        }

        .track-release-date {
            position: absolute;
            left: 180px;
            top: 74px;
            font-family: Helvetica, sans-serif;
            font-size: 18px;
            font-weight: normal;
            color: #666;
        }

        .track-separator {
            position: absolute;
            left: 62px;
            top: 108px;
            width: 100%;
            height: 10px;
            background-color: #ddd;
            border-radius: 5px;
        }

        .track-progress {
            position: absolute;
            left: 62px;
            top: 108px;
            height: 10px;
            background-color: #303030;
            border-radius: 5px;
        }

        .track-list-right {
            position: absolute;
            left: 1491px;
            top: 57px;
            width: 508px;
        }

        .album-info {
            position: absolute;
            top: 979px;
            display: flex;
            gap: 166px;
            left: 404px;
        }

        .info-item {
            text-align: left;
        }

        .info-label {
            font-family: Helvetica, sans-serif;
            font-size: 24px;
            font-weight: bold;
            color: black;
            margin-bottom: 8px;
        }

        .info-value {
            font-family: Helvetica, sans-serif;
            font-size: 24px;
            font-weight: normal;
            color: black;
        }

        .barcode-image {
            position: absolute;
            left: 65px;
            top: 960px;
            width: 258px;
            height: 8px;
        }
    </style>
    <script>
        function adjustTrackTitleSize() {
            const trackTitles = document.querySelectorAll('.track-title');
            const maxWidth = 440;
            const maxHeight = 45;
            let globalFontSize = 35;
            let needsWrapping = false;

            // First pass: find the minimum font size needed across all tracks
            trackTitles.forEach(title => {
                title.style.whiteSpace = 'nowrap';
                let fontSize = 35;
                title.style.fontSize = fontSize + 'px';

                // Find minimum font size for this track
                while (fontSize >= 18 && title.scrollWidth > maxWidth) {
                    fontSize -= 1;
                    title.style.fontSize = fontSize + 'px';
                }

                // Track the smallest font size needed
                globalFontSize = Math.min(globalFontSize, fontSize);

                // Check if any track needs wrapping even at minimum font
                if (fontSize <= 18 && title.scrollWidth > maxWidth) {
                    needsWrapping = true;
                }
            });

            // Second pass: apply uniform font size and wrapping to all tracks
            trackTitles.forEach(title => {
                if (needsWrapping) {
                    title.style.fontSize = Math.max(14, globalFontSize * 0.85) + 'px';
                    title.style.whiteSpace = 'normal';
                } else {
                    title.style.fontSize = globalFontSize + 'px';
                    title.style.whiteSpace = 'nowrap';
                }
            });
        }

        window.addEventListener('load', function() {
            // Small delay to ensure all content is rendered
            setTimeout(() => {
                adjustAlbumTitleSize();
                adjustTrackTitleSize();
            }, 100);
        });
    </script>
</head>
<body>
    <div class="container">
        <!-- Album Cover -->
        <div class="album-cover"></div>

        <!-- Artist and Album Title -->
        {% if artist %}
            <div class="artist-name">{{artist}}</div>
            <div class="album-title">{{album}}</div>
        {% else %}
            <div class="artist-name">Artist</div>
            <div class="album-title">Album</div>
        {% endif %}

        <!-- Color Palette -->
        <div class="color-1"></div>
        <div class="color-2"></div>
        <div class="color-3"></div>
        <div class="color-4"></div>
        <div class="color-5"></div>

        <!-- Separator Line -->
        <div class="separator-line"></div>

        {% if tracklist %}
            {% set tracks = tracklist.keys() | sort %}
            {% set total_tracks = tracks | length %}
            {% if total_tracks > 20 %}
                {% set tracks = tracks[:20] %}
                {% set total_tracks = 20 %}
            {% endif %}
            {% set half = ((total_tracks) / 2) | round(0, 'ceil') | int %}
        {% else %}
            {% set total_tracks = 12 %}
            {% set half = 6 %}
        {% endif %}

        <!-- Calculate dynamic sizing -->
        {% set available_height = 700 %}
        {% set track_height = (available_height / half) | round(0) | int %}
        {% set font_scale = (track_height / 117) %}
        {% set title_font = (35 * font_scale) | round(0) | int %}
        {% set duration_font = (24 * font_scale) | round(0) | int %}
        {% set number_font = (35 * font_scale) | round(0) | int %}
        {% set title_width = [200, (311 * font_scale) | round(0) | int] | max %}

        <!-- Track List Left Column -->
        <div class="track-list">
            {% for i in range(half) %}
                {% if tracklist %}
                    {% set track_num = tracks[i] %}
                    {% set track_data = tracklist[track_num] %}
                {% else %}
                    {% set track_num = i + 1 %}
                    {% set track_data = {'title': 'Track ' + (track_num | string), 'length': 'N/A', 'release_date': 'N/A'} %}
                {% endif %}

                <div class="track-item" style="height: {{ track_height }}px; margin-bottom: {{ (29 * font_scale) | round(0) | int }}px;">
                    <div class="track-number" style="font-size: {{ number_font }}px; top: {{ (track_height * 0.3) | round(0) | int }}px;">{{ track_num }}.</div>
                    <div class="track-title" style="font-size: {{ title_font }}px; top: {{ (track_height * 0.13) | round(0) | int }}px; width: 440px;">{{ track_data.title }}</div>
                    <div class="track-duration" style="font-size: {{ duration_font }}px; top: {{ (track_height * 0.63) | round(0) | int }}px;">{{ track_data.length }}</div>
                    {% if track_data.release_date %}
                        <div class="track-release-date" style="font-size: {{ (duration_font * 0.75) | round(0) | int }}px; top: {{ (track_height * 0.63) | round(0) | int }}px;">{{ track_data.release_date }}</div>
                    {% endif %}
                    <div class="track-separator" style="top: {{ (track_height * 0.92) | round(0) | int }}px; height: {{ (10 * font_scale) | round(0) | int }}px;"></div>
                    <div class="track-progress" style="top: {{ (track_height * 0.92) | round(0) | int }}px; height: {{ (10 * font_scale) | round(0) | int }}px; width: {{ track_data.pct if track_data.pct else 50 }}%;"></div>
                </div>
            {% endfor %}
        </div>

        <!-- Track List Right Column -->
        <div class="track-list-right">
            {% for i in range(half, total_tracks) %}
                {% if tracklist %}
                    {% set track_num = tracks[i] %}
                    {% set track_data = tracklist[track_num] %}
                {% else %}
                    {% set track_num = i + 1 %}
                    {% set track_data = {'title': 'Track ' + (track_num | string), 'length': 'N/A', 'release_date': 'N/A'} %}
                {% endif %}

                <div class="track-item" style="height: {{ track_height }}px; margin-bottom: {{ (29 * font_scale) | round(0) | int }}px;">
                    <div class="track-number" style="font-size: {{ number_font }}px; top: {{ (track_height * 0.3) | round(0) | int }}px;">{{ track_num }}.</div>
                    <div class="track-title" style="font-size: {{ title_font }}px; top: {{ (track_height * 0.13) | round(0) | int }}px; width: 440px;">{{ track_data.title }}</div>
                    <div class="track-duration" style="font-size: {{ duration_font }}px; top: {{ (track_height * 0.63) | round(0) | int }}px;">{{ track_data.length }}</div>
                    {% if track_data.release_date %}
                        <div class="track-release-date" style="font-size: {{ (duration_font * 0.75) | round(0) | int }}px; top: {{ (track_height * 0.63) | round(0) | int }}px;">{{ track_data.release_date }}</div>
                    {% endif %}
                    <div class="track-separator" style="top: {{ (track_height * 0.92) | round(0) | int }}px; height: {{ (10 * font_scale) | round(0) | int }}px;"></div>
                    <div class="track-progress" style="top: {{ (track_height * 0.92) | round(0) | int }}px; height: {{ (10 * font_scale) | round(0) | int }}px; width: {{ track_data.pct if track_data.pct else 50 }}%;"></div>
                </div>
            {% endfor %}
        </div>

        <!-- Album Information Footer -->
        <div class="album-info">
            <div class="info-item">
                <div class="info-label">Release Date</div>
                <div class="info-value">{{date}}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Run Time</div>
                <div class="info-value">{{run_time}}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Track Count</div>
                <div class="info-value">{{track_count}}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Country</div>
                <div class="info-value">{{country}}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Format</div>
                <div class="info-value">{{format}}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Type</div>
                <div class="info-value">{{type}}</div>
            </div>
        </div>

        <!-- Barcode Area -->
        <div class="barcode-image">
            <img src="{{ barcode_src }}">
        </div>
    </div>

    <script>
      async function fitAlbumTitleToCover() {
        const cover = document.querySelector('.album-cover');
        const title = document.querySelector('.album-title');
        if (!cover || !title) return;

        // wait for fonts so measurements are accurate
        if (document.fonts && document.fonts.ready) {
          try { await document.fonts.ready; } catch(e) {}
        }

        const maxWidth = cover.clientWidth;   // 680px in your CSS
        const minSize = 12;                   // allow going smaller if needed
        const maxSize = 96;

        title.style.whiteSpace = 'nowrap';    // force single line
        title.style.overflow = 'visible';     // let us measure true width
        title.style.fontSize = maxSize + 'px';

        // binary search the largest size that fits
        let lo = minSize, hi = maxSize, best = minSize;
        while (lo <= hi) {
          const mid = Math.floor((lo + hi) / 2);
          title.style.fontSize = mid + 'px';
          // force a reflow so scrollWidth is fresh
          void title.offsetWidth;
          if (title.scrollWidth <= maxWidth) {
            best = mid;
            lo = mid + 1;
          } else {
            hi = mid - 1;
          }
        }
        title.style.fontSize = best + 'px';
        title.style.overflow = 'hidden';      // restore your clipping
      }

      window.addEventListener('load', () => {
        setTimeout(() => {
          fitAlbumTitleToCover();
          adjustTrackTitleSize();  // keep your existing function
        }, 100);
      });



        function adjustTrackTitleSize() {
            const trackTitles = document.querySelectorAll('.track-title');
            const maxWidth = 440;
            const maxHeight = 45;
            let globalFontSize = 35;
            let needsWrapping = false;

            // First pass: find the minimum font size needed across all tracks
            trackTitles.forEach(title => {
                title.style.whiteSpace = 'nowrap';
                let fontSize = 35;
                title.style.fontSize = fontSize + 'px';

                // Find minimum font size for this track
                while (fontSize >= 18 && title.scrollWidth > maxWidth) {
                    fontSize -= 1;
                    title.style.fontSize = fontSize + 'px';
                }

                // Track the smallest font size needed
                globalFontSize = Math.min(globalFontSize, fontSize);

                // Check if any track needs wrapping even at minimum font
                if (fontSize <= 18 && title.scrollWidth > maxWidth) {
                    needsWrapping = true;
                }
            });

            // Second pass: apply uniform font size and wrapping to all tracks
            trackTitles.forEach(title => {
                if (needsWrapping) {
                    title.style.fontSize = Math.max(14, globalFontSize * 0.85) + 'px';
                    title.style.whiteSpace = 'normal';
                } else {
                    title.style.fontSize = globalFontSize + 'px';
                    title.style.whiteSpace = 'nowrap';
                }
            });
        }

        window.addEventListener('load', function() {
            // Small delay to ensure all content is rendered
            setTimeout(() => {
                adjustAlbumTitleSize();
                adjustTrackTitleSize();
            }, 100);
        });
    </script>
</body>
</html>